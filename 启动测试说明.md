# 一、启动与测试说明（Step-by-step）
## 先决条件
Redis 已安装并启动（本机 127.0.0.1:6379）
MySQL安装启动，并创建对应名字的数据库:"process.env.DB_NAME || 'essay_app',"
Python 3.10+（建议虚拟环境），Node.js 18+（已安装 npm）
记得在yonghuguanli\yonghuguanli和zuowen两个目录下都先运行nmp install！！！ 
阿里云 DashScope 账号正常可用并有对应模型权限
配置环境变量
1) Python 微服务（目录：zuowen）
在 zuowen/.env 写入：

DASHSCOPE_API_KEY=你的有效Key(百炼平台注册，我的也快欠费了所以最好自己注册一个，有免费额度)
PYTHON_API_URL=http://127.0.0.1:8000
// 意思就是：访问本地和阿里云时，绝对不要走任何代理！（就算不开梯子最好也写上）
NO_PROXY=127.0.0.1,localhost,dashscope.aliyuncs.com

2) Node 用户管理（目录：yonghuguanli/yonghuguanli）
在该目录创建 .env（如不存在）：
PORT=3000
JWT_SECRET=dev_secret
PYTHON_API_URL=http://127.0.0.1:8000
安装依赖
1) Python 侧（zuowen）
pip install -r requirements.txt
2) Node 侧（yonghuguanli/yonghuguanli）
npm install
首次生成 PDF 前执行（在 zuowen 目录或 Node 项目根，任选其一执行一次）：
npx puppeteer browsers install chrome
说明：让 Puppeteer 使用自带的稳定 Chromium，避免系统 Chrome 版本不匹配。
## 启动顺序
强烈建议开三个独立终端窗口。
1) 启动 Celery Worker（zuowen）
Windows 下优先用更稳的单进程模式（避免 eventlet 绿化问题）：
celery -A tasks.celery_app worker --loglevel=info -P solo -c 1
如需高并发再换：
celery -A tasks.celery_app worker --loglevel=info -P eventlet -c 50
2) 启动 FastAPI（zuowen）
uvicorn main:app --host 0.0.0.0 --port 8000
打开 http://127.0.0.1:8000/docs 确认在线。
3) 启动 Node 主服务（yonghuguanli/yonghuguanli）
npm run dev
健康检查：http://localhost:3000/health
测试页：http://localhost:3000/test/
在 /test 页进行完整测试
1) 登录
“登录”区域点击“登录”；成功后当前 token 会显示并写入 localStorage('auth_token')
2) 兑换积分（正式积分流，管理员生成码 → 用户兑换）
浏览器控制台执行（在 /test 同源页签内）：
生成码（管理员）：
fetch('/api/admin/generate-codes', {
method:'POST',
headers:{'Content-Type':'application/json'},
body: JSON.stringify({ count:1, points:100, expireDays:30 })
}).then(r=>r.json()).then(console.log)
兑换（用户）：
const token=localStorage.getItem('auth_token');
const code='上一步返回的codes[0]';
fetch('/api/points/redeem', {
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
body:JSON.stringify({code})
}).then(r=>r.json()).then(console.log)
步骤 3：查询余额（验证扣费/加点）
如果直接查余额没有步骤一，先运行
const token = localStorage.getItem('auth_token');
console.log('token =', token);
if (!token) console.warn('请先在 /test 页面登录，或确保是在 http://localhost:3000/test 打开的同源页面');

之后再
fetch('/api/points/balance', {
headers: { Authorization: 'Bearer ' + token }
}).then(r => r.json()).then(console.log)

3) 提交作文
选择图片（可多张），点击“提交” → 得到 recordId（标准返回 {code:0,data:{recordId}}）
4) 轮询结果
点击“开始轮询” → status 由 processing → completed
返回体中 result.pdf_path / result.json_path 可在本机对应路径打开核对（Python 服务 runs/<时间戳_随机>/ 目录）
5) 再次查余额
提交消耗默认 10 分/次（可在 essayController.js 的 DEDUCTION_PER_SUBMISSION 调整）
再次 fetch /api/points/balance 验证扣费

开发态注意事项（防止端口拒绝/崩溃）
nodemon.json（已写好）会忽略 uploads/runs/test-client 等目录，避免上传/删除触发热重启，重启请用 Ctrl+C 手工。
若仍出现 net::ERR_CONNECTION_REFUSED，先用 node server.js 直跑，查看第一条堆栈迅速定位。