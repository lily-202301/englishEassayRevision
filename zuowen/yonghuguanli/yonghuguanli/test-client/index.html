<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>作文批改 测试页</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans SC', sans-serif; margin: 20px; }
    fieldset { margin-bottom: 16px; }
    label { display: inline-block; min-width: 120px; }
    input[type=text], input[type=password], input[type=url] { width: 360px; padding: 6px; }
    .row { margin: 6px 0; }
    button { padding: 6px 12px; }
    pre { background: #f6f8fa; padding: 10px; overflow:auto; max-height: 300px; }
    .muted { color: #666; font-size: 12px; }
    .ok { color: #0a0; }
    .err { color: #a00; }
  </style>
</head>
<body>
  <h2>作文批改 测试页（Node 主服务 + Python 微服务）</h2>

  <fieldset>
    <legend>环境/模式</legend>
    <div class="row">
      <label>API 基址</label>
      <input id="baseUrl" type="url" placeholder="http://localhost:3000" />
      <span class="muted">默认同源（留空则使用当前站点）。</span>
    </div>
    <div class="row">
      <label>接口模式</label>
      <select id="mode">
        <option value="node">Node 当前后端（/api/auth/login, /api/essay/submit, /api/essay/result/:id）</option>
        <option value="spec">前端同学的未来规范（/api/user/login, /api/essay/upload, /api/essay/essay_analysis/:id）</option>
      </select>
    </div>
  </fieldset>

  <fieldset>
    <legend>登录（获取 token）</legend>
    <div class="row"><label>phone</label><input id="phone" type="text" value="13800000000" /></div>
    <div class="row"><label>code</label><input id="code" type="text" value="1234" /></div>
    <div class="row"><label>openid/username</label><input id="openid" type="text" value="wx_openid_demo" /></div>
    <div class="row">
      <button id="btnLogin">登录</button>
      <span id="loginMsg" class="muted"></span>
    </div>
    <div class="row muted">当前 token：<span id="tokenView">(未登录)</span></div>
  </fieldset>

  <fieldset>
    <legend>提交作文（多图）</legend>
    <div class="row"><label>文本（可选）</label><input id="text" type="text" placeholder="可留空" /></div>
    <div class="row"><label>图片</label><input id="images" type="file" multiple accept="image/*" /></div>
    <div class="row">
      <button id="btnSubmit">提交</button>
      <span id="submitMsg" class="muted"></span>
    </div>
    <div class="row muted">record/analysis id：<span id="rid">(暂无)</span></div>
  </fieldset>

  <fieldset>
    <legend>轮询结果</legend>
    <div class="row"><label>间隔(ms)</label><input id="interval" type="text" value="3000" /></div>
    <div class="row">
      <button id="btnPoll">开始轮询</button>
      <button id="btnStop">停止</button>
      <span id="pollMsg" class="muted"></span>
    </div>
    <h4>结果</h4>
    <pre id="result"></pre>
  </fieldset>

  <script>
    const $ = (id)=>document.getElementById(id);
    const state = {
      token: localStorage.getItem('auth_token') || '',
      rid: '',
      timer: null
    };

    function getBase(){
      const v = $('baseUrl').value.trim();
      return v || location.origin;
    }
    function setToken(t){
      state.token = t || '';
      if(t){ localStorage.setItem('auth_token', t); }
      $('tokenView').textContent = t ? t.slice(0,24)+'...' : '(未登录)';
    }
    setToken(state.token);

    async function http(method, url, {data, headers, isForm}={}){
      const h = headers || {};
      if(state.token) h['Authorization'] = 'Bearer '+state.token;
      let body;
      if(isForm){ body = data; }
      else if(data){ h['Content-Type']='application/json'; body = JSON.stringify(data); }
      const res = await fetch(url, { method, headers: h, body });
      const txt = await res.text();
      let json; try{ json = txt ? JSON.parse(txt) : {}; }catch{ json = { raw: txt }; }
      // 兼容封装/直返
      if(json && (json.data!==undefined || json.code!==undefined || json.success!==undefined)) return json;
      return { code: res.ok?0:res.status, msg: res.statusText, data: json };
    }

    $('btnLogin').onclick = async ()=>{
      const base = getBase();
      const mode = $('mode').value;
      $('loginMsg').textContent = '登录中...';
      try{
        let url, payload;
        if(mode==='node'){
          url = base + '/api/auth/login';
          payload = { phone: $('phone').value, code: $('code').value, openid: $('openid').value };
        }else{
          url = base + '/api/user/login';
          payload = { username: $('openid').value, password: $('code').value };
        }
        const r = await http('POST', url, { data: payload });
        const token = r?.data?.token || r?.token || (r?.data && r.data);
        if(!token) throw new Error('未返回 token');
        setToken(token);
        $('loginMsg').textContent = '登录成功';
        $('loginMsg').className='ok';
      }catch(e){
        $('loginMsg').textContent = '登录失败: '+e.message;
        $('loginMsg').className='err';
      }
    };

    $('btnSubmit').onclick = async ()=>{
      const base = getBase();
      const mode = $('mode').value;
      $('submitMsg').textContent = '上传中...';
      try{
        const fd = new FormData();
        const files = $('images').files;
        if(!files || files.length===0) throw new Error('请选择至少一张图片');
        const text = $('text').value.trim();
        if(mode==='node'){
          // 我们当前后端：字段名 images，多次
          for(const f of files){ fd.append('images', f, f.name); }
          if(text) fd.append('prompt', text);
          const r = await http('POST', base + '/api/essay/submit', { data: fd, isForm:true });
          const rid = r?.data?.recordId || r?.recordId || r?.data?.id;
          if(!rid) throw new Error('未拿到 recordId');
          state.rid = rid;
        }else{
          // 前端规范：/api/essay/upload，字段 text可选，图片字段 photo[] 可多次
          if(text) fd.append('text', text);
          for(const f of files){ fd.append('photo[]', f, f.name); }
          const r = await http('POST', base + '/api/essay/upload', { data: fd, isForm:true });
          const rid = r?.data?.analysis_id || r?.analysis_id || r?.data?.id;
          if(!rid) throw new Error('未拿到 analysis_id');
          state.rid = rid;
        }
        $('rid').textContent = state.rid;
        $('submitMsg').textContent = '提交成功，已获得ID';
        $('submitMsg').className = 'ok';
      }catch(e){
        $('submitMsg').textContent = '提交失败: '+e.message;
        $('submitMsg').className='err';
      }
    };

    $('btnPoll').onclick = ()=>{
      if(!state.rid){ $('pollMsg').textContent = '请先提交获取ID'; return; }
      const interval = parseInt($('interval').value||'3000',10);
      $('pollMsg').textContent = '开始轮询...';
      if(state.timer) clearInterval(state.timer);
      state.timer = setInterval(pollOnce, interval);
      pollOnce();
    };

    $('btnStop').onclick = ()=>{
      if(state.timer) clearInterval(state.timer);
      $('pollMsg').textContent = '已停止';
    };

    async function pollOnce(){
      const base = getBase();
      const mode = $('mode').value;
      try{
        let url;
        if(mode==='node') url = base + '/api/essay/result/' + encodeURIComponent(state.rid);
        else url = base + '/api/essay/essay_analysis/' + encodeURIComponent(state.rid);
        const r = await http('GET', url);
        // 容错解析展示
        const data = r?.data ?? r;
        $('result').textContent = JSON.stringify(data, null, 2);
        const status = data?.status || data?.data?.status;
        if(status==='completed' || status==='SUCCESS'){
          $('pollMsg').textContent = '已完成';
          if(state.timer) clearInterval(state.timer);
        }
      }catch(e){
        $('pollMsg').textContent = '轮询出错: '+e.message;
      }
    }

    // 默认把 base 设为同源
    $('baseUrl').value = location.origin;
  </script>
</body>
</html>

