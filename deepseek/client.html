<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek Stress Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-10 font-mono">
    <div class="max-w-2xl mx-auto space-y-6">
        <h1 class="text-3xl font-bold text-blue-400">DeepSeek å‹æµ‹ç»ˆç«¯</h1>
        
        <!-- é…ç½®åŒºåŸŸ -->
        <div class="bg-gray-800 p-4 rounded-lg space-y-4">
            <div>
                <label class="block text-sm text-gray-400 mb-1">æœåŠ¡å™¨åœ°å€ (Server URL)</label>
                <!-- æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦åŠ  /docsï¼Œåªè¦ IP:ç«¯å£ -->
                <input type="text" id="serverUrl" value="http://119.45.187.169:8000" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="username" placeholder="ç”¨æˆ·å" class="bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white">
                <input type="password" id="password" placeholder="å¯†ç " class="bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white">
            </div>
            <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded font-bold transition-colors">1. ç™»å½• (Login)</button>
            <div id="statusMsg" class="text-xs text-center min-h-[1.5em]"></div>
        </div>

        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="bg-gray-800 p-4 rounded-lg space-y-4">
            <div id="chatBox" class="h-64 bg-gray-900 rounded p-4 overflow-y-auto space-y-2 border border-gray-700 text-sm">
                <div class="text-gray-500 text-center italic">Ready...</div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="msgInput" class="flex-1 bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button onclick="sendMsg()" class="bg-green-600 px-6 rounded font-bold hover:bg-green-500">å‘é€</button>
            </div>
        </div>

        <!-- å‹åŠ›æµ‹è¯• -->
        <div class="bg-gray-800 p-4 rounded-lg border border-red-900/50">
            <h3 class="text-red-400 font-bold mb-2">ğŸš€ å¹¶å‘æµ‹è¯•åŒº</h3>
            <button onclick="bombard()" class="w-full bg-red-600 hover:bg-red-500 py-3 rounded font-bold flex justify-center items-center gap-2 transition-colors">
                <span>æ¨¡æ‹Ÿ 20 äººåŒæ—¶æé—®</span>
            </button>
            <pre id="stressLog" class="mt-4 text-[10px] text-gray-400 h-32 overflow-y-auto bg-black p-2 rounded border border-gray-800"></pre>
        </div>
    </div>

    <script>
        let token = '';
        let sessionId = null;

        function getUrl() {
            // å»æ‰æœ«å°¾çš„æ–œæ 
            return document.getElementById('serverUrl').value.replace(/\/$/, "");
        }

        function setStatus(msg, type) {
            const el = document.getElementById('statusMsg');
            el.innerText = msg;
            el.className = "text-xs text-center min-h-[1.5em] " + (type === 'error' ? 'text-red-500' : 'text-green-400');
        }

        function logChat(role, text) {
            const box = document.getElementById('chatBox');
            // ä½¿ç”¨æœ€åŸå§‹çš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œé˜²æ­¢è½¬ä¹‰é”™è¯¯
            let colorClass = 'text-left text-green-300';
            if (role === 'You') colorClass = 'text-right text-blue-300';
            if (role === 'Error') colorClass = 'text-center text-red-500';

            const html = '<div class="' + colorClass + '"><strong>' + role + ':</strong> ' + text + '</div>';
            box.innerHTML += html;
            box.scrollTop = box.scrollHeight;
        }

        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(!u || !p) return setStatus("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ", "error");

            setStatus("ç™»å½•ä¸­...", "normal");
            
            const formData = new URLSearchParams();
            formData.append('username', u);
            formData.append('password', p);

            try {
                const res = await fetch(getUrl() + '/token', {
                    method: 'POST',
                    body: formData,
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'}
                });
                const data = await res.json();
                
                if(data.access_token) {
                    token = data.access_token;
                    setStatus("ç™»å½•æˆåŠŸï¼æ­£åœ¨åˆ›å»ºä¼šè¯...", "success");
                    await initSession();
                } else {
                    setStatus("ç™»å½•å¤±è´¥: " + JSON.stringify(data), "error");
                }
            } catch(e) { 
                setStatus("ç½‘ç»œé”™è¯¯: " + e, "error"); 
            }
        }

        async function initSession() {
            try {
                const res = await fetch(getUrl() + '/sessions', {
                    method: 'POST',
                    headers: {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'},
                    body: JSON.stringify({title: "Web Client Session"})
                });
                const data = await res.json();
                if(data.id) {
                    sessionId = data.id;
                    setStatus("ä¼šè¯å·²å»ºç«‹ (ID: " + sessionId + ")ã€‚å¯ä»¥å¼€å§‹èŠå¤©äº†ï¼", "success");
                    logChat("System", "Session Ready.");
                } else {
                    setStatus("åˆ›å»ºä¼šè¯å¤±è´¥", "error");
                }
            } catch(e) {
                setStatus("ä¼šè¯é”™è¯¯: " + e, "error");
            }
        }

        async function sendMsg() {
            const msgInput = document.getElementById('msgInput');
            const msg = msgInput.value;
            if(!msg || !sessionId) return;
            
            logChat("You", msg);
            msgInput.value = '';

            try {
                const res = await fetch(getUrl() + '/sessions/' + sessionId + '/chat', {
                    method: 'POST',
                    headers: {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'},
                    body: JSON.stringify({message: msg})
                });
                const data = await res.json();
                
                if (data.detail) {
                     logChat("Error", typeof data.detail === 'string' ? data.detail : JSON.stringify(data.detail));
                } else {
                     // data.reply åº”è¯¥åŒ…å« "Task Queued: xxx"
                     logChat("Bot", data.reply); 
                }
            } catch(e) {
                logChat("Error", e);
            }
        }

        async function bombard() {
            if(!sessionId) return alert("è¯·å…ˆç™»å½•å¹¶åˆ›å»ºä¼šè¯ï¼");
            
            const log = document.getElementById('stressLog');
            log.innerText = "ğŸš€ å¼€å§‹ 20 å¹¶å‘è½°ç‚¸...\n";
            
            const requests = [];
            for(let i=1; i<=20; i++) {
                // æ¯ä¸€ä¸ªè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„å¼‚æ­¥æ“ä½œ
                const req = fetch(getUrl() + '/sessions/' + sessionId + '/chat', {
                    method: 'POST',
                    headers: {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'},
                    body: JSON.stringify({message: "Stress Test Message #" + i})
                })
                .then(res => res.json())
                .then(data => {
                    const reply = data.reply || JSON.stringify(data);
                    log.innerText += "è¯·æ±‚ " + i + " å“åº”: " + reply + "\n";
                })
                .catch(err => {
                    log.innerText += "è¯·æ±‚ " + i + " å¤±è´¥: " + err + "\n";
                });
                
                requests.push(req);
            }
            
            await Promise.all(requests);
            log.innerText += "âœ… æ‰€æœ‰è¯·æ±‚å·²å‘é€è‡³ Redis é˜Ÿåˆ—ï¼\nè¯·è§‚å¯ŸæœåŠ¡å™¨åå°æ—¥å¿—çœ‹å¤„ç†è¿‡ç¨‹ã€‚";
        }
    </script>
</body>
</html>